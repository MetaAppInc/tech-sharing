# 深入理解计算机系统

### 第四章  处理器体系结构

### 1、Y86-64指令级体系结构

状态单元、指令集（ISA）和编码、编码规范和异常事件处理

- 程序可见的状态，通过指令读取或修改处理器状态的某些部分。 Y86-64可以访问和修改程序寄存器、条件码、程序计数器（PC）和内存。状态码指明程序是否运行正常。
- Y86-64指令

    （1）是x86-64指令集的一个子集，只包括8字节整数操作，寻址方式较少，操作少； 

    （2）和x86-64结构一样有15个程序寄存器，每个程序存储一个64位（8字节）的字。 

    （3）x86常数值1、2、4、8字节，Y86常数值是8字节。

- 指令编码

    ![%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%2098b366becefa40919b616169d6ddcc1d%201.jpg](%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%2098b366becefa40919b616169d6ddcc1d%201.jpg)

    （1）指令编码长度1-10字节不等 

    （2）指令第一个字节表明指令类型，分两部分，每部分4位，高4位代码部分，低四位功能部分 （3）指令集是字节编码的唯一解释 

    （4）其他指令集

- Y86-64异常
- Y86-64程序
- 一些Y86-64指令的详情

### 2、逻辑设计和硬件控制语言HCL

用高电压和低电压表示不同的位值

- 逻辑门 and、or、not
- 组合电路和HCL布尔表达式 很多的逻辑门组合成一个网 多路复用：根据输入控制信号的值，从一组不同的数据信号中选出一个 bool out=(s && a)||(!s && b)；
- 字级的组合电路和HCL整数表达式 word out=[s:A;1B]
- 集合关系
- 存储器和时钟 时钟寄存器（硬件寄存器）：存储单个位或字，加载输入值 随机访问寄存器（程序寄存器）：内存，存储多个字，用地址选择读哪个字，1）处理器的虚拟内存系统 ；2）寄存器文件

### 3、Y86-64的顺序实现

- 将处理组织成阶段 
取指：从内存中读取字节 
译码：从寄存器文件读取最多两个操作数 
执行：ALU执行指令 
访存：从内存中写入或读出数据 
写回：最多两个结果写回到寄存器文件 更新PC：将PC设置成下一条指令的地址
- SEQ硬件结构 每个指令在一个时钟周期内完成
- SEQ的时序 seq的实现包括组合逻辑和两种存储器设备
- SEQ阶段的实现

### 4、流水线的通用原理

### 小结

指令集体系结构在处理器行为和如何实现处理器之间提供了一层抽象，提供了程序执行的一种顺序说明（一条指令执行完了，下一条指令才会开始） Y86-64指令集既有RISC指令集的属性，也有CISC指令集的属性，据此构造SEQ处理器，其中每个时钟周期执行一条指令，它会通过所有五个阶段

### 第五章  优化程序性能

### 1、优化编译器的能力和局限性

大多数编译器提供了一些优化控制；
最简单的控制就是制定优化级别、

### 2、表示程序性能

引入度量标准每元素的周期数（CPE），作为表示程序性能并指导我们改进代码的方法。
理解迭代程序的循环性能

### 3、程序示例

### 4、消除循环的低效率

### 5、较少过程调用

### 6、消除不必要的内存引用

减少不必要的内存引用

### 7、现代处理器

针对目标处理器进行调整、所以需要理解现代处理器

### 8、循环展开

通过增加每次迭代计算的元素的数量，减少循环迭代次数

### 9、提高并行性

多个累计变量、重新结合变换等

### 10、性能提高技术

高级设计、基本编码原则、低级优化

### 小结

描述了编译器是如何生成高效代码的；
妨碍优化的因素（内存别名使用和过程调用，严重限制编译器执行大量优化的能力）；
对处理器结构有所理解，以便针对不同处理器作相应调整；
一些优化技术：循环展开、创建多个累计变量和重新结合，可以利用现代处理器的指令级并行等；还可以根据必须要计算的操作数量以及执行这些操作的功能单元的数量和发射时间得到计算的吞吐量界限；
 注意存储和加载操作。将数值保存在局部变量中，使得他们可以存放在寄存器中；
 处理大型程序可借助相关工具，GPROF，Unix剖析工具等，估计程序每个基本块的性能。

### 第六章  存储器的层次结构

CPU执行指令，存储器系统为CPU存放指令和数据

存储系统是一个具有不同容量、成本和访问时间的存储设备的层次结构

### 1、存储技术

- 随机访问存储器 
（1）静态RAM（SRAM、更快、每个单元用六晶体管电路来实现的）高速缓存存储器，可以用在CPU芯片上或其他一些需要高速访问的地方
（2）动态RAM（DRAM、每个位存储对一个电容的充电），用作主存或者图形系统的帧缓冲区
增强的DRAM，生产厂商为跟上处理器速度，会不定期对传统DRAM作一些优化。
- 非易失性存储器
如果过断电RAM会丢失信息
PROM只能写一次
EPROM可擦写可编程，可擦除和重写的次数可达1000次
EEPROM电子可擦除，10的5次方
闪存（基于EEPROM），大部分用的这类
固态硬盘（SSD）是基于闪存的磁盘驱动器
引导开机的BIOS存储
- 访问主存
通过总线的共享电子电路在处理器和DRAM主存之间传递，这些步骤称总线事务
- 磁盘存储：
可以存储更多的数据量，比DRAM慢10万倍，比SRAM慢100万倍
磁盘构造：盘片（表面覆盖磁性记录材料，磁盘表面由一组磁道的同心圆组成，每个磁道划分成一组扇区）
磁盘由一个或多个叠放在一起的盘片组层的
可旋转的主轴
衡量磁盘的容量：磁道记录密度、磁道密度、面密度
- 固态硬盘
基于闪存的存储技术、封装一个或多个闪存芯片和闪存翻译层组成，闪存芯片代替传统旋转机械驱动器
SSD读比写快（擦除块需要相对较长的时间、修改已有数据将已有数据复制到新块）
访问快，耗能低但摩擦有寿命

### 2、局部性

倾向于引用邻近于其他最近引用过得数据项或最近引用过得数据项本身，这种倾向性被称为局部性原理。时间局部性和空间局部性，有良好局部性的程序运行更快。

- 取指令的局部性，循环有好的时间和空间局部性
- 对步长为k的引用模式（连续向量中每隔k个元素进行访问），步长越小，空间局部性越好
- 重复引用相同变量的程序有良好的时间局部性

### 3、存储器层次结构

![%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%2098b366becefa40919b616169d6ddcc1d/image-20210330161851682.png](%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%2098b366becefa40919b616169d6ddcc1d/image-20210330161851682.png)

根据访问速度和价格成本、时间局部性（同一数据对象多次使用）、空间局部性（复用存储块）构建。

### 5、高速缓存

直接映射高速缓存：每组缓存数只有一行
组相连高速缓存：每组有多行的缓存行
全相连高速缓存：由一个包含所有高速缓存行组构成。

### 6、高速缓存对程序性能的影响

存储山：衡量单台计算机的存储系统能力的抽象化，山脊是时间局部性，斜坡时空间局部性

在程序中利用局部性

### 小结

基本存储技术包括随机存储器（RAM）、非易失性存储器和磁盘；
RAM有两种：静态SRAM（可做CPU和芯片的高速缓存）比DRAM（用作主存和图形帧缓冲区）快些 非易失性存储器（ROM）和磁盘：可以用来存储固件
 固态硬盘（SSD）基于非易失性的闪存 DRAM和磁盘访问时间远远大于CPU周期时间，系统通过将存储器组织成存储设备的层次结构来弥补这些差异 
通过编写有良好空间和时间局部性的程序来显著的改进程序的运行时间。
